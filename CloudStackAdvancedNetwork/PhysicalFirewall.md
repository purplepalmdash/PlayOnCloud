## 用防火墙保护CloudStack 

### 网络接口配置

网络， 查看接口， 注意我们配置的地址:    

![/images/2015_11_17_19_36_31_722x389.jpg](/images/2015_11_17_19_36_31_722x389.jpg)   

详细的配置如下:    

![/images/2015_11_17_19_38_36_678x530.jpg](/images/2015_11_17_19_38_36_678x530.jpg)   

注意我们的公网端口如下:     

![/images/2015_11_17_19_39_45_560x340.jpg](/images/2015_11_17_19_39_45_560x340.jpg)    

详细配置:    

![/images/2015_11_17_19_40_58_718x633.jpg](/images/2015_11_17_19_40_58_718x633.jpg)    

### DHCP服务器配置
可以给内网配置DHCP服务, 这样链接到cloudstack接口的每一个客户端都可以自动获取到IP地址：    

![/images/2015_11_17_19_45_01_662x372.jpg](/images/2015_11_17_19_45_01_662x372.jpg)   

具体配置如下:    

![/images/2015_11_17_19_46_03_810x405.jpg](/images/2015_11_17_19_46_03_810x405.jpg)    

### NAT配置
菜单如下，点击防火墙-> NAT -> 源NAT：    

![/images/2015_11_17_19_41_56_548x438.jpg](/images/2015_11_17_19_41_56_548x438.jpg)    

具体的配置参数如下，注意我们选择的Zone以及接口配置:    

![/images/2015_11_17_19_43_01_725x506.jpg](/images/2015_11_17_19_43_01_725x506.jpg)   

到这里，就可以从内网访问到Internet上的任一主机了。接下来对内网作限流.     

### 限流
点击防火墙-> 限流策略, 首先打开`限流策略`.     

![/images/2015_11_17_19_47_43_476x367.jpg](/images/2015_11_17_19_47_43_476x367.jpg)    

配置每IP限流:    

![/images/2015_11_17_19_48_24_607x358.jpg](/images/2015_11_17_19_48_24_607x358.jpg)    

具体策略如下:    

![/images/2015_11_17_19_49_50_701x576.jpg](/images/2015_11_17_19_49_50_701x576.jpg)   

![/images/2015_11_17_19_50_34_686x539.jpg](/images/2015_11_17_19_50_34_686x539.jpg)    

perip的定义如下:    

![/images/2015_11_17_19_51_17_562x195.jpg](/images/2015_11_17_19_51_17_562x195.jpg)    

详细配置:    

![/images/2015_11_17_19_51_50_686x335.jpg](/images/2015_11_17_19_51_50_686x335.jpg)   

整体限流配置如下:     

![/images/2015_11_17_19_52_34_661x327.jpg](/images/2015_11_17_19_52_34_661x327.jpg)   

限流的class配置和上面类似,不过这里是设置全局的。   
 
### 测试   
使用多个并发连接来测试。   

![/images/2015_11_17_19_54_02_352x408.jpg](/images/2015_11_17_19_54_02_352x408.jpg)    

可以看到，当连接数到达我们配置好的525左右后，内网机器将无法再发起新的连接。    

查看命中次数，也证实了限流和限连接数的成功:    

![/images/2015_11_17_19_55_19_453x187.jpg](/images/2015_11_17_19_55_19_453x187.jpg)   

在首页可以看到当前连接会话的个数:    

![/images/2015_11_17_19_58_16_538x266.jpg](/images/2015_11_17_19_58_16_538x266.jpg)     
