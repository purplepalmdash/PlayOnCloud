## CloudStackAllInOneCentOS7 
这里记载在CentOS7上搭建AllInOne环境。    

### 网络配置
如上所示，加入到某隔绝网络中，我们选择`10.168.100.1/24`这个网络作为该节点所处的网络，设
置地址如下:    

```
# vim /etc/sysconfig/network-scripts/ifcfg-eth0 
    # Generated by dracut initrd
    NAME="eth0"
    ONBOOT=yes
    NETBOOT=yes
    UUID="51916db1-8f30-458d-a958-3f4adff662ea"
    IPV6INIT=yes
    BOOTPROTO=static
    IPADDR=10.168.100.20
    GATEWAY=10.168.100.1
    NETMASK=255.255.255.0
    DNS1=223.5.5.5
    TYPE=Ethernet
$ yum install -y net-tools vim bridge-utils
```

现在创建网桥cloudbr0:    

```
# cat /etc/sysconfig/network-scripts/ifcfg-eth0
    DEVICE=eth0
    TYPE=Ethernet
    ONBOOT=yes
    NM_CONTROLLED=yes
    BOOTPROTO=none
    BRIDGE=cloudbr0
    IPV6INIT=no
# cat /etc/sysconfig/network-scripts/ifcfg-cloudbr0 
    DEVICE=cloudbr0
    TYPE=Bridge
    BOOTPROTO=static
    IPADDR=10.168.100.20
    GATEWAY=10.168.100.1
    NETMASK=255.255.255.0
    DNS1=223.5.5.5
    IPV6INIT=no 
    ONBOOT=yes
    DELAY=0
```

### FQDN
主机名及FQDN配置如下:    

```
# vim /etc/hosts
    10.168.100.20           cloudstackc7
    127.0.0.1               localhost
    ::1     localhost       ip6-localhost   ip6-loopback
    fe00::0 ip6-localnet
    ff00::0 ip6-mcastprefix
    ff02::1 ip6-allnodes
    ff02::2 ip6-allrouters
# vim /etc/hostname
    cloudstackc7
```
检查主机名如下:    

```
# hostname
    cloudstackc7
# hostname --fqdn
    cloudstackc7
```

### 准备仓库
用预先准备好的cloudstack centos7仓库:    

```
# yum install -y wget
# wget http://192.168.0.79/cloudstack7.repo
# yum makecache
# yum search cloudstack
```

### CloudStack Management服务器

#### NTP
安装和配置ntp服务:    

```
# yum install -y ntp

# vim /etc/ntp.conf
    driftfile /var/lib/ntp/drift

    restrict default kod nomodify notrap nopeer noquery
    restrict -6 default kod nomodify notrap nopeer noquery

    restrict 127.0.0.1 
    restrict -6 ::1

    server 0.uk.pool.ntp.org iburst
    server 1.uk.pool.ntp.org iburst
    server 2.uk.pool.ntp.org iburst
    server 3.uk.pool.ntp.org iburst

    includefile /etc/ntp/crypto/pw

    keys /etc/ntp/keys

    disable monitor
# service ntpd restart
# chkconfig ntpd on
```

#### SELinux

禁止SELinux:    

```
# vim /etc/selinux/config
SELINUX=disabled
SELINUXTYPE=targeted
```

#### 安装CloudStack-Management
CentOS7 使用mariadb代替了MySQL:   

```
# yum install -y mariadb-server
# yum install -y MySQL-python
```

配置数据库, 在/etc/my.cnf的[mysqld_safe]条目前添加如下定义后，重新启动mariadb并确保其在
开机时自动加载:    

```
# vim /etc/my.cnf
  + # CloudStack MySQL settings
    + innodb_rollback_on_timeout=1
    + innodb_lock_wait_timeout=600
    + max_connections=700
    + log-bin=mysql-bin
    + binlog-format = 'ROW'
    + bind-address=0.0.0.0

    [mysqld_safe]
# service mariadb status
# service mariadb start
# chkconfig mariadb on
```

移除 anonymous 用户:

```
# mysql
mysql>  SELECT User, Host, Password FROM mysql.user;
+------+-----------+----------+
| User | Host      | Password |
+------+-----------+----------+
| root | localhost |          |
| root | csmgmt    |          |
| root | 127.0.0.1 |          |
|      | localhost |          |
|      | csmgmt    |          |
+------+-----------+----------+
mysql> DROP USER ''@'cloudstackc7'; 
mysql> DROP USER ''@'localhost'; 
mysql>  SELECT User, Host, Password FROM mysql.user;
+------+-----------+----------+
| User | Host      | Password |
+------+-----------+----------+
| root | localhost |          |
| root | csmgmt    |          |
| root | 127.0.0.1 |          |
+------+-----------+----------+
3 rows in set (0.00 sec)
```

删除testdb:

```
mysql> select * from mysql.db;
........
mysql> DELETE FROM mysql.db WHERE Db LIKE 'test%';
Query OK, 2 rows affected (0.00 sec)

mysql> select * from mysql.db;
Empty set (0.00 sec)
mysql> DROP DATABASE test;
Query OK, 0 rows affected (0.00 sec)

mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.00 sec)
mysql> \q
Bye
```

加密MYSQL安装并更改root用户密码，可以通过以下命令完成, 第一次输入空密码，而后可以设置
root用户的访问密码:

```
# mysql_secure_installation
```

配置防火墙，关闭firewalld, 开启iptables:    

```
# systemctl mask firewalld
# yum -y install iptables-services
# systemctl enable iptables
```
开启 iptables规则:

```
# iptables -A INPUT -p tcp -m tcp --dport 3306 -j ACCEPT
# iptables-save>/etc/sysconfig/iptables
# reboot
```

#### CloudStack-Management安装包
安装:    

```
#  yum install -y cloudstack-management
``` 

#### Cloudmonkey
从epel仓库安装pip后，用pip安装cloudmonkey:   

```
# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
# yum install -y python-pip
# pip install cloudmonkey
```

#### 配置数据库
这里用到的root密码即我们在`mysql_secure_installation`中设置的root密码:   

```
# cloudstack-setup-databases cloud:engine@localhost --deploy-as=root:xxxxx -i
10.168.100.20
```

#### 配置CloudStack Management
配置命令:   

```
# cloudstack-setup-management
```
现在打开浏览器访问`http://10.168.100.20:8080/client`则可以访问到CloudStack的配置页面，
使用admin/password登录即可

### NFS存储配置
配置NFS共享存储目录:   

```
# mkdir -p /export/primary /export/secondary
```

编辑导出目录定义:    

```
$ cat >>/etc/exports <<EOM
/export  *(rw,async,no_root_squash,no_subtree_check)
EOM
```

开启并使能rpcbind及nfs-server服务：   

```
# systemctl start rpcbind nfs-server
# systemctl enable rpcbind nfs-server
```

加载到/etc/fstab条目:    

```
$ IP=10.168.100.10
$ mkdir -p /mnt/primary /mnt/secondary
$ cat >>/etc/fstab <<EOM
$IP:/export/primary   /mnt/primary    nfs    
rsize=8192,wsize=8192,timeo=14,intr,vers=3,noauto  0   2
$IP:/export/secondary /mnt/secondary  nfs    
rsize=8192,wsize=8192,timeo=14,intr,vers=3,noauto  0   2
EOM
$ mount /mnt/primary
$ mount /mnt/secondary
```

### 系统虚拟机模板
使用下列命令引入系统虚拟机模板到二级存储中:    

```
# /usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m
 /mnt/secondary/ -u http://192.168.0.79/systemvm64template-4.5-kvm.qcow2.bz2 -h kvm -F
```

### CloudStack Agent
安装包:    

```
# yum install -y cloudstack-agent
```

需要更改掉以下配置中的选项后重启libvirtd:    

```
# sed -i 's/#vnc_listen = "0.0.0.0"/vnc_listen = "0.0.0.0"/g' \ 
 /etc/libvirt/qemu.conf && sed -i 's/cgroup_ \ 
 controllers=["cpu"]/#cgroup_controllers=["cpu"]/g' /etc/libvirt/qemu.conf
# sed -i 's/#listen_tls = 0/listen_tls = 0/g' \ 
  /etc/libvirt/libvirtd.conf && sed -i 's/#listen_tcp = 1/listen_tcp = 1/g' \
  /etc/libvirt/libvirtd.conf && sed -i \ 
 's/#tcp_port = "16509"/tcp_port = "16509"/g' \
 /etc/libvirt/libvirtd.conf && sed -i 's/#auth_tcp = "sasl"/auth_\
 tcp = "none"/g' /etc/libvirt/libvirtd.conf && \
 sed -i 's/#mdns_adv = 1/mdns_adv = 0/g' /etc/libvirt/libvirtd.conf
# sed -i 's/#LIBVIRTD_ARGS="--listen"/LIBVIRTD_ARGS="--listen"/g' \
 /etc/sysconfig/libvirtd 
# sed -i '/cgroup_controllers/d' \
  /usr/lib64/python2.7/site-packages/cloudutils/serviceConfig.py
```

重启libvirtd:    

```
# service libvirtd restart
```

### 配置
添加一个基本的Zone:    

![/images/2015_10_16_09_40_34_692x447.jpg](/images/2015_10_16_09_40_34_692x447.jpg)   

设置DNS Server并选择kvm:    
![/images/2015_10_16_09_44_17_566x519.jpg](/images/2015_10_16_09_44_17_566x519.jpg)    

网络类型选择如下:    

![/images/2015_10_16_09_45_33_483x275.jpg](/images/2015_10_16_09_45_33_483x275.jpg)    

直接点击下一步，进入到POD配置:    

![/images/2015_10_16_09_50_12_511x453.jpg](/images/2015_10_16_09_50_12_511x453.jpg)    

Guest Traffic配置:   

![/images/2015_10_16_09_51_10_484x331.jpg](/images/2015_10_16_09_51_10_484x331.jpg)    

配置Cluster:    

![/images/2015_10_16_09_55_36_482x231.jpg](/images/2015_10_16_09_55_36_482x231.jpg)   

添加host:    

![/images/2015_10_16_09_56_20_483x373.jpg](/images/2015_10_16_09_56_20_483x373.jpg)   

添加主存储:    

![/images/2015_10_16_09_57_04_593x467.jpg](/images/2015_10_16_09_57_04_593x467.jpg)    

添加二级存储:    

![/images/2015_10_16_09_58_05_520x372.jpg](/images/2015_10_16_09_58_05_520x372.jpg)    

最后一步点击Launch Zone。CloudStack All In One的环境在CentOS 7上就搭建完毕了。
